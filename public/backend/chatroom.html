<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//media.twiliocdn.com/sdk/js/video/releases/2.0.0-beta1/twilio-video.min.js"></script>
    <script>
      $(document).ready(function(){

          //connect to room

          const { connect } = require('twilio-video');

connect('$TOKEN', { name:'my-new-room' }).then(room => {
  console.log(`Successfully joined a Room: ${room}`);
  room.on('participantConnected', participant => {
    alert((`A remote Participant connected: ${participant}`);
  });
}, error => {
  alert(`Unable to connect to Room: ${error.message}`);
});


//join room

const { connect } = require('twilio-video');

connect('$TOKEN', { name: 'existing-room' }).then(room => {
  console.log(`Successfully joined a Room: ${room}`);
  room.on('participantConnected', participant => {
    alert(`A remote Participant connected: ${participant}`);
  });
}, error => {
  alert(`Unable to connect to Room: ${error.message}`);
});

//local media setup

const { connect, createLocalTracks } = require('twilio-video');

// Option 1
createLocalTracks({
  audio: true,
  video: { width: 640 }
}).then(localTracks => {
  return connect('$TOKEN', {
    name: 'my-room-name',
    tracks: localTracks
  });
}).then(room => {
  console.log(`Connected to Room: ${room.name}`);
});

// Option 2
connect('$TOKEN', {
  audio: true,
  name: 'my-room-name',
  video: { width: 640 }
}).then(room => {
  console.log(`Connected to Room: ${room.name}`);
});

//Handle Connected Participants

// Log your Client's LocalParticipant in the Room
const localParticipant = room.localParticipant;
console.log(`Connected to the Room as LocalParticipant "${localParticipant.identity}"`);

// Log any Participants already connected to the Room
room.participants.forEach(participant => {
  console.log(`Participant "${participant.identity}" is connected to the Room`);
});

// Log new Participants as they connect to the Room
room.once('participantConnected', participant => {
  console.log(`Participant "${participant.identity}" has connected to the Room`);
});

// Log Participants as they disconnect from the Room
room.once('participantDisconnected', participant => {
  console.log(`Participant "${participant.identity}" has disconnected from the Room`);
});


//handle participants connection events
room.on('participantConnected', participant => {
  console.log(`Participant connected: ${participant.identity}`);
});

room.on('participantDisconnected', participant => {
  console.log(`Participant disconnected: ${participant.identity}`);
});




//Display a Remote Participant's Video

// Attach the Participant's Media to a <div> element.
    room.on('participantConnected', participant => {
  console.log(`Participant "${participant.identity}" connected`);

  participant.tracks.forEach(publication => {
    if (publication.isSubscribed) {
      const track = publication.track;
      document.getElementById('remote-media-div').appendChild(track.attach());
    }
  });

  participant.on('trackSubscribed', track => {
    document.getElementById('remote-media-div').appendChild(track.attach());
  });
});

//display camera preview

const { createLocalVideoTrack } = require('twilio-video');

createLocalVideoTrack().then(track => {
  const localMediaContainer = document.getElementById('local-media');
  localMediaContainer.appendChild(track.attach());
});

//disconnect from room

room.on('disconnected', room => {
  // Detach the local media elements
  room.localParticipant.tracks.forEach(publication => {
    const attachedElements = publication.track.detach();
    attachedElements.forEach(element => element.remove());
  });
});

// To disconnect from a Room
room.disconnect();

  
        });
        
    </script>
</head>
<body>
    <form action="/token" method="GET">
        <input type="submit" value="join chat"/>
    </form>
    <div id="remote-media-div" style="width:800px;height:800px; border:1px solid;">

    </div>
    
</body>
</html>
